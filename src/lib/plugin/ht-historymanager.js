!function(a,b,c){"use strict";var d="ht",e=a[d],f=e.Default,g=f.def,h=f.getInternal();e.HistoryManager=function(a){this._histories=[],this.setDataModel(a)},g(e.HistoryManager,b,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var a=this;a._betweenTransaction++,1===a._betweenTransaction&&(a._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var a=this,b=a._histories;if(a._betweenTransaction>0&&a._betweenTransaction--,0===a._betweenTransaction){if(a._transactionHistories){var c=[];for(var d in a._transactionHistories)c.push(a._transactionHistories[d]);c.length&&(b=b.slice(0,a._historyIndex+1),b.push(c),b.length>a._maxHistoryCount&&(b=b.slice(b.length-a._maxHistoryCount)),a.setHistories(b),a.setHistoryIndex(b.length-1,!0))}delete a._transactionHistories}}},setDataModel:function(a){var b=this,c=b._dataModel;c!==a&&(c&&(delete c._historyManager,c.ump(b.handleDataModelPropertyChange,b),c.umm(b.$5p,b),c.umd(b.$6p,b),c.removeHierarchyChangeListener(b.handleHierarchyChange,b),c.removeIndexChangeListener(b.handleIndexChange,b)),b._dataModel=a,a&&(a._historyManager=b,a.mp(b.handleDataModelPropertyChange,b),a.mm(b.$5p,b),a.md(b.$6p,b),a.addHierarchyChangeListener(b.handleHierarchyChange,b),a.addIndexChangeListener(b.handleIndexChange,b)),b.fp("dataModel",c,a),b.clear())},setHistoryIndex:function(a,b){var c=this,d=c._historyIndex,e=c._histories.length;if(-1>a?a=-1:a>=e&&(a=e-1),d!==a){if(!b){var f=a-d;f>0?c.$2p(f):0>f&&c.$1p(-f)}c._historyIndex=a,c.fp("historyIndex",d,a),c.dataModel&&c.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(a){var b=this,c=b._histories,d=b._maxHistoryCount;(!a||0>=a)&&(a=10),d!==a&&(b._maxHistoryCount=a,b.fp("maxHistoryCount",d,a),c.length>a&&b.clear())},cloneValue:function(a,b,c){return e.Default.clone(a)},isPropertyUndoable:function(a,b){return a&&!this.ignoredPropertyMap[a]},isIndexUndoable:function(a){return!1},isDataModelPropertyUndoable:function(a,b){return a&&!this.ignoreDataModelPropertyMap[a]},$5p:function(a){this.handleChange(a,a.kind)},$6p:function(a){this.handleChange(a,"property")},handleHierarchyChange:function(a){this.handleChange(a,"hierarchy")},handleIndexChange:function(a){this.handleChange(a,"index")},handleDataModelPropertyChange:function(a){this.handleChange(a,"dataModelProperty")},toChildrenInfo:function(a){var b={};return b.data=a,b.children=[],a.eachChild(function(a){b.children.push(this.toChildrenInfo(a))},this),b},restoreChildren:function(a){var b=a.data;a.children.forEach(function(a){var c=a.data;c.getParent()!==b&&b.addChild(c),this._dataModel.contains(c)||this._dataModel.add(c),this.restoreChildren(a)},this)},handleChange:function(a,b){var d=this;if(!(d._disabled||d._isUndoRedoing||f.loadingRefGraph)){var g,h=(d._histories,a.data),i=a.property;if(!h||!(h._refGraph||h instanceof e.RefGraph)){if("property"===b)d.isPropertyUndoable(i,h)&&(g={kind:b,data:h,property:i,oldValue:d.cloneValue(a.oldValue,h,i),newValue:d.cloneValue(a.newValue,h,i),event:a});else if("hierarchy"===b||"index"===b&&d.isIndexUndoable(a))g={kind:b,data:h,oldIndex:a.oldIndex,newIndex:a.newIndex,event:a};else if("clear"===b)g={kind:b,json:a.json,event:a};else if("add"===b){if(g={kind:b,data:h,event:a,childrenInfo:this.toChildrenInfo(h),parent:h.getParent()},g.parent){var j=d._dataModel.getSiblings(h);g.siblingsIndex=j.indexOf(h)}h instanceof e.Node&&(g.host=h.getHost(),g.attaches=h.getAttaches()?h.getAttaches().toArray():c),h instanceof e.Edge&&(g.source=h.getSource(),g.target=h.getTarget())}else"remove"===b?g={kind:b,data:h,event:a}:"dataModelProperty"===b&&d.isDataModelPropertyUndoable(i,h)&&(g={kind:b,property:i,oldValue:d.cloneValue(a.oldValue,h,i),newValue:d.cloneValue(a.newValue,h,i),event:a});d.addHistory(g)}}},addHistory:function(a){var b=this;if(a)if(b._betweenTransaction){var c=(a.data?a.data._id:0)+"_"+a.kind+"_"+a.property;if("property"===a.kind||"dataModelProperty"===a.kind){var d=b._transactionHistories[c];d&&(a.oldValue=d.oldValue)}b._transactionHistories[c]=a}else{var e=b._histories;e=e.slice(0,b._historyIndex+1),e.push([a]),e.length>b._maxHistoryCount&&(e=e.slice(e.length-b._maxHistoryCount)),b.setHistories(e),b.setHistoryIndex(e.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(a){(!a||0>=a)&&(a=1),this.setHistoryIndex(this._historyIndex-a)},$1p:function(a){if(this.canUndo()){var b,c=this,d=c._dataModel,e=c._histories,g=c._historyIndex,i=0;for(c._isUndoRedoing=!0,f.setIsolating(!0);a>0;){if(g>=0&&g<e.length){i++,b=e[g],g--;for(var j=b.length-1;j>=0;j--){var k=b[j],l=k.kind,m=k.data,n=k.property,o=k.event,p=this.cloneValue(k.oldValue,m,n);if(k.undo)k.undo();else if("add"===l)d.remove(m,{keepChildren:!0});else if("remove"===l)d.contains(m)||d.add(m,o.rootsIndex,o.datasIndex);else if("clear"===l)d.deserialize(f.clone(k.json));else if("property"===l)if("parent"===n)p?p.addChild(m,o.oldIndex):(m.setParent(p),o.oldIndex>=0&&d.moveTo(m,o.oldIndex));else{var q=null;0===n.indexOf("a:")?(q="attr",n=n.replace("a:","")):0===n.indexOf("s:")?(q="style",n=n.replace("s:","")):0===n.indexOf("f:")&&(q="field",n=n.replace("f:","")),h.setPropertyValue(m,q,n,p)}else if("dataModelProperty"===l){var q=null;0===n.indexOf("a:")?(q="attr",n=n.replace("a:","")):0===n.indexOf("s:")?(q="style",n=n.replace("s:","")):0===n.indexOf("f:")&&(q="field",n=n.replace("f:","")),h.setPropertyValue(d,q,n,p)}else"hierarchy"===l?d.moveTo(m,k.oldIndex):"index"===l&&d.moveToIndex(m,k.oldIndex)}}a--}f.setIsolating(!1),delete c._isUndoRedoing,c.afterUndo(i)}},afterUndo:function(a){},redo:function(a){(!a||0>=a)&&(a=1),this.setHistoryIndex(this._historyIndex+a)},$2p:function(a){if(this.canRedo()){var b,c=this,d=c._dataModel,g=c._histories,i=c._historyIndex,j=0;for(c._isUndoRedoing=!0,f.setIsolating(!0);a>0;){if(i>=-1&&i<g.length-1){j++,i++,b=g[i];for(var k=0;k<b.length;k++){var l=b[k],m=l.kind,n=l.data,o=l.property,p=l.event,q=this.cloneValue(l.newValue,n,o);if(l.redo)l.redo();else if("add"===m)l.parent&&!n.getParent()&&l.parent.addChild(n,l.siblingsIndex),d.contains(n)||d.add(n,p.rootsIndex,p.datasIndex),this.restoreChildren(l.childrenInfo),n instanceof e.Node&&(n.setHost(l.host),l.attaches&&l.attaches.forEach(function(a){a.setHost(n)})),n instanceof e.Edge&&(n.setSource(l.source),n.setTarget(l.target));else if("remove"===m)d.remove(n);else if("clear"===m)d.clear();else if("property"===m)if("parent"===o)q?q.addChild(n,p.newIndex):(n.setParent(q),p.newIndex>=0&&d.moveTo(n,p.newIndex));else{var r=null;0===o.indexOf("a:")?(r="attr",o=o.replace("a:","")):0===o.indexOf("s:")?(r="style",o=o.replace("s:","")):0===o.indexOf("f:")&&(r="field",o=o.replace("f:","")),h.setPropertyValue(n,r,o,q)}else if("dataModelProperty"===m){var r=null;0===o.indexOf("a:")?(r="attr",o=o.replace("a:","")):0===o.indexOf("s:")?(r="style",o=o.replace("s:","")):0===o.indexOf("f:")&&(r="field",o=o.replace("f:","")),h.setPropertyValue(d,r,o,q)}else"hierarchy"===m?d.moveTo(n,l.newIndex):"index"===m&&d.moveToIndex(n,l.newIndex)}}a--}f.setIsolating(!1),delete c._isUndoRedoing,this.afterRedo(j)}},afterRedo:function(a){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);